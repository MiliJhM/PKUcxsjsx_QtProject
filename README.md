# 程序设计实习 Qt作业报告

### 107 单抽出货队

源代码：[Github项目地址](https://github.com/MiliJhM/PKUcxsjsx_QtProject)

## 1. 程序功能介绍

### 1.1 概述

利用C++ Qt实现的2D回合制棋类游戏。游戏主要内容为在国际象棋的棋盘上失去其它棋子的黑王独自面对敌方棋子进攻，但黑王有一把霰弹枪。

在目前的项目实践中，我们实现了如下功能：

1. 基于`QWidget`与`QGraphicsView`实现的游戏界面和游戏逻辑；
2. 基于`QGraphicsScene`实现的游戏场景布置；
3. 基于重载Qt鼠标事件实现的鼠标操控。
4. 基于`QMultiMedia`库实现的音效播放。

### 1.2 游戏内容介绍

在主菜单放置开始、难度调节和读取存档（未实现）按钮控件。选择难度开始游戏后进入游戏界面，其上有一国际象棋棋盘和一个玩家操控的黑王棋子。

在游戏中，黑王可以：

1. 点击黑王，黑王进入选中状态，然后点击周围八个格子（合法的）进行移动（如果移动地点有敌方单位则进行一次攻击，伤害为攻击力*弹丸量）；
2. 点击黑王，黑王进入选中状态，然后点击黑王跳过本回合；
3. 点击黑王，黑王进入选中状态，点击非法的格子取消选中；
4. 在非选中状态点击其它位置，霰弹枪向鼠标方向开火，子弹为随机分布，被子弹击中的敌人会受到伤害。

黑王具备如下属性：

1. 生命值
2. 防御力，采用减法计算（敌方攻击力-防御力，小于0则无视本次伤害）；
3. 攻击力，为每颗子弹的伤害。
4. 闪避值，以百分数的闪避概率表示；
5. 霰弹散布，以散布角表示；
6. 霰弹数量

敌方单位有如下属性：

1. 生命值
2. 攻击力

同时如国际象棋，敌方单位共分六种：

1. 兵(Pawn):
   > 兵为敌军的基准单位，数量多但移动缓慢；
2. 马(Knight)：
   > 马相较兵移动更快，血量更高；
3. 象(Bishop)：
   > 象移动力强，血量少但攻击力高；
4. 车(Rook)：
   > 车移动力强，血量高但攻击力低；
5. 后(Queen)：
   > 后移动力最强，攻击力和血量处于一般水平；
6. 王(King)：
   > 王移动力较弱，但攻击力和血量均远高于兵。

不同敌方单位的移动逻辑不同，具体参考国际象棋规则；除取消选中外的行动都会计入行动次数，每达到一定的行动次数，都会进入敌方回合，产生新的敌方单位，已有的敌方单位会开始移动；若在行动回合敌方单位可以移动到黑王位置（马除移动位置外可以攻击周围八格），则视为该棋子对黑王进行了一次攻击。攻击不会使得棋子的位置发生改变。

不同的敌方单位死亡会提供不同的经验值，经验值达到一定量后黑王获得生命回复和属性提升。（本意采用Rougelike机制，即获得一定量可选的随机提升项，时间不够）

击杀敌方单位达到一定量时敌方单位也会增强。

当击杀单位达到200时视为游戏胜利，黑王中途死亡则视为游戏失败。

### 1.3 游戏实现介绍

游戏采用C++ Qt实现，素材部分自制，部分采用网络免费素材和往届Qt开源项目素材，在MSVC C++14(WinSDK 10.0.19041.0)、Qt 5.15.2(MSVC2019)下可编译。

## 2. 项目模块介绍与类设计细节

### 2.1 游戏窗口：GameWidgetNew

该类继承`QWidget`，实现游戏主窗口，并用于初始化、操纵和显示两个继承于`QGraphicsView`的主要逻辑类`StartMenuNew`和`GameManager`；这两个类通过信号机制对`GameWidget`进行操作，从而实现游戏内退出至菜单和重新开始的功能。

### 2.2 开始菜单：StartMenuNew

该类继承`QGraphicsView`，实现游戏的开始菜单。三个按钮通过信号机制连接`GameWidget`和`GameManager`。

### 2.3 游戏界面：GameManager

继承自`QGraphicsView`，实现游戏界面。该类同时承载了游戏逻辑。敌方棋子的产生、移动和指针，我方棋子的属性、操控都保存在该类中，根据游戏进程进行动态调整。该类：

* 通过若干`QLabel`子类和label重设方法实现在不同信号（敌方死亡，我方受伤，我方升级）下的属性显示；
* 通过保存的两个`QGraphicsScene`实现游戏主界面和游戏结算界面的切换；
* 通过重载的鼠标事件实现黑王的互动和鼠标操控。

### 2.4 黑王：PlayerPiece

一个`QGraphicsPixmapItem`，主要用于黑王的呈现和动画效果。黑王受伤（实际逻辑在`GameManager`中进行）会调用该类的`hurt`方法，进而实现红色闪烁特效。

### 2.5 武器：Shotgun

同为`QGraphicsPixmapItem`，用于霰弹枪的呈现、功能和动画效果。

* 鼠标的移动会调用该类的`rotateToCursor`方法，从而实现霰弹枪的跟随移动；
* 鼠标点击会调用该类的`fire`方法，实现霰弹枪开火特效和弹丸产生。
* 黑王的移动会调用该类的`updatePos`方法，在移动过程中隐藏并在移动结束后在正确位置重现。

### 2.6 弹丸：Bullet

同样是`GraphicsPixmapItem`， 用于弹丸的呈现、功能。

* 由全局计时器不断调用其`move`和`enemyHitCheck`方法；
* `move`方法实现在发射方向不断移动；
* `enemyHitCheck`进行碰撞检测，如果碰撞到敌方单位则对敌方单位造成伤害；
* 具备一定的穿透次数，穿透次数用完后消失。（穿透次数的增加机制未实装）

### 2.7 敌军：BotBase

`QGraphicsPixmapItem`派生的类，用于敌方单位的呈现、动画效果和一部分行动逻辑。

* 行动回合，`GameManager`会对全部棋子调用`attackableCheck`方法，若该方法返回true，代表棋子能够攻击到黑王，此时进行攻击；
* `attack`方法实现了棋子的攻击动画，返回值作为伤害量由`GameManager`处理。
* `moveRound`方法使得棋子向棋盘内可以移动的离黑王最近的位置移动；（本意对每一棋子设定特定的行动逻辑，但时间不够作罢）
* `moveToEffect`实现移动特效，移动时传播`botMove`信号，`GameManager`对其进行处理，移动其在指针池中的位置。
* 被子弹碰撞时调用`hurt`方法，实现属性调整和伤害特效。
* 伤害致死时传播`botDeath`信号，`GameManager`对其进行后处理，删除空指针等操作

在该类的基础上重载`moveRound`、`attackableCheck`等方法派生出BotPawn、BotKnight等类，同时保留BotBase的构造能力作为功能测试类

### 2.8 已知bug：

1. 在移动回合，原棋子本应移动的情况下，新产生的棋子部分情况下会覆盖原棋子，原棋子不移动；

## 4. 项目总结与反思

### 4.1 总结

总体来说项目使得我们对C++面向对象编程范式理解更加深入，同时也学到了一些GUI编程的基本知识，增强了中型项目的构建能力，一定程度上补全了多文件编程的经验空白。对于Qt信号机制的使用使得面向对象编程变得相对简单，也为我们提供了多对象间互动的一些机制借鉴。

### 4.2 反思

1. 前期对于窗口和界面的实现过于繁复，重写界面浪费了大量时间；
2. 对于Qt各个模块的理解程度不够，不能采用最优方法实现；
3. 对于项目的完成时间错误估计，导致收尾时间不够；
4. 对于子弹的实现比较粗糙，大量重复的碰撞检测导致程序在子弹过多时产生卡顿；
5. 源代码并未做到漂亮的分模块管理，混乱地放置在根目录下；应当试图采用`Make`系统进行编译链管理，同时对源代码不同部分分文件夹管理。